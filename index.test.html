<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Socket.IO Chat Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #chatList button {
        margin: 5px;
      }
      #messages {
        border: 1px solid #ccc;
        padding: 10px;
        height: 200px;
        overflow-y: scroll;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Socket.IO Chat Test</h1>

    <div>
      <label>JWT Token:</label>
      <input type="text" id="token" style="width: 400px" />
      <button onclick="authenticate()">Authenticate</button>
    </div>

    <hr />

    <div>
      <button onclick="fetchChatList()">Fetch Chat List</button>
      <div id="chatList"></div>
    </div>

    <hr />

    <div>
      <h3>Chat Room</h3>
      <div id="messages"></div>
      <input
        type="text"
        id="chatInput"
        placeholder="Type message..."
        style="width: 300px"
      />
      <button onclick="sendMessage()">Send</button>
    </div>

    <script>
      const socket = io("http://localhost:5000"); // change port if needed
      let currentChatUserId = null;
      let currentChatUserRole = null;

      socket.on("connect", () => {
        console.log("✅ Connected to server", socket.id);
      });

      socket.on("authenticated", (data) => {
        console.log("✅ Authenticated:", data);
      });

      socket.on("chatList", (list) => {
        console.log("📋 Chat List:", list);
        const container = document.getElementById("chatList");
        container.innerHTML = "";
        list.forEach((contact) => {
          const btn = document.createElement("button");
          btn.textContent = `${contact.name} (${contact.role})`;
          btn.onclick = () => joinChat(contact._id, contact.role);
          container.appendChild(btn);
        });
      });

      socket.on("chatHistory", (messages) => {
        console.log("📝 Chat History:", messages);
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";
        messages.forEach((m) => {
          const p = document.createElement("p");
          p.textContent = `[${m.sender.userModel}] ${m.text}`;
          messagesDiv.appendChild(p);
        });
      });

      socket.on("newMessage", (message) => {
        const messagesDiv = document.getElementById("messages");
        const p = document.createElement("p");
        p.textContent = `[${message.sender.userModel}] ${message.text}`;
        messagesDiv.appendChild(p);
      });

      function authenticate() {
        const token = document.getElementById("token").value;
        socket.emit("credentials", token);
      }

      function fetchChatList() {
        socket.emit("fetchChatList");
      }

      function joinChat(userId, role) {
        currentChatUserId = userId;
        currentChatUserRole = role;
        socket.emit("joinChat", userId, role);
      }

      function sendMessage() {
        const text = document.getElementById("chatInput").value;
        if (!currentChatUserId || !currentChatUserRole || !text) return;
        socket.emit("sendMessage", {
          chatUserId: currentChatUserId,
          chatUserRole: currentChatUserRole,
          text,
        });
        document.getElementById("chatInput").value = "";
      }
    </script>
  </body>
</html>
